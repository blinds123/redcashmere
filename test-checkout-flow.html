<!DOCTYPE html>
<html>
<head>
  <title>Checkout Flow Test</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    .test-section { margin: 20px 0; padding: 15px; border: 2px solid #ddd; border-radius: 8px; }
    .success { background: #d4edda; border-color: #28a745; }
    .error { background: #f8d7da; border-color: #dc3545; }
    .info { background: #d1ecf1; border-color: #17a2b8; }
    button { padding: 12px 24px; margin: 5px; font-size: 16px; cursor: pointer; border-radius: 6px; border: none; background: #8B2942; color: white; }
    button:hover { opacity: 0.9; }
    pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Checkout Flow Test</h1>
  
  <div class="test-section info">
    <h2>Pool Server Status</h2>
    <div id="poolStatus">Testing...</div>
  </div>

  <div class="test-section">
    <h2>Test Checkout Buttons</h2>
    <p>These simulate the actual checkout flow:</p>
    <button onclick="testCheckout(59, 'primary')">Test $59 Tier (Primary)</button>
    <button onclick="testCheckout(19, 'secondary')">Test $19 Tier (Pre-order)</button>
    <div id="testResult" style="margin-top: 15px;"></div>
  </div>

  <div class="test-section">
    <h2>Test Order Bump Flow</h2>
    <button onclick="testOrderBump()">Test Order Bump Popup</button>
    <div id="bumpResult" style="margin-top: 15px;"></div>
  </div>

  <div class="test-section">
    <h2>Integration Logs</h2>
    <pre id="logs" style="max-height: 300px; overflow-y: auto;"></pre>
  </div>

  <script>
    const POOL_API = 'https://simpleswap-automation-1.onrender.com';
    const logs = [];

    function log(msg) {
      const timestamp = new Date().toLocaleTimeString();
      logs.push(`[${timestamp}] ${msg}`);
      document.getElementById('logs').textContent = logs.join('\n');
    }

    // Test pool server health
    async function testPoolHealth() {
      try {
        log('Checking pool server health...');
        const response = await fetch(`${POOL_API}/health/pools`);
        const data = await response.json();
        log('Pool health: ' + JSON.stringify(data, null, 2));
        
        const statusDiv = document.getElementById('poolStatus');
        statusDiv.innerHTML = `
          <strong>Status:</strong> ${data.status}<br>
          <strong>$19 Pool:</strong> ${data.pools['19'].status} (${data.pools['19'].size} wallets)<br>
          <strong>$29 Pool:</strong> ${data.pools['29'].status} (${data.pools['29'].size} wallets)<br>
          <strong>$59 Pool:</strong> ${data.pools['59'].status} (${data.pools['59'].size} wallets)
        `;
        statusDiv.parentElement.className = 'test-section success';
      } catch (error) {
        log('Pool health check failed: ' + error.message);
        document.getElementById('poolStatus').textContent = 'Error: ' + error.message;
        document.getElementById('poolStatus').parentElement.className = 'test-section error';
      }
    }

    // Test checkout flow
    async function testCheckout(amount, type) {
      log(`Testing ${type} tier checkout for $${amount}...`);
      const resultDiv = document.getElementById('testResult');
      resultDiv.innerHTML = '<em>Processing...</em>';
      
      try {
        const response = await fetch(`${POOL_API}/buy-now`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amountUSD: amount })
        });
        
        const data = await response.json();
        log('Checkout response: ' + JSON.stringify(data, null, 2));
        
        if (data.success && data.exchangeUrl) {
          resultDiv.innerHTML = `
            <div class="test-section success">
              <strong>✓ Success!</strong><br>
              Exchange URL: <a href="${data.exchangeUrl}" target="_blank">${data.exchangeUrl}</a><br>
              Pool Status: ${data.poolStatus}
            </div>
          `;
          log(`✓ Checkout test passed for $${amount}`);
        } else {
          resultDiv.innerHTML = `<div class="test-section error">Failed: ${JSON.stringify(data)}</div>`;
          log(`✗ Checkout test failed for $${amount}`);
        }
      } catch (error) {
        log('Checkout error: ' + error.message);
        resultDiv.innerHTML = `<div class="test-section error">Error: ${error.message}</div>`;
      }
    }

    // Test order bump flow
    function testOrderBump() {
      log('Testing order bump flow...');
      const bumpDiv = document.getElementById('bumpResult');
      
      bumpDiv.innerHTML = `
        <div class="test-section info">
          <h3>Order Bump Simulation</h3>
          <p>For $19 pre-order tier:</p>
          <ul>
            <li>User clicks pre-order button</li>
            <li>Popup shows: Add Cardigan for $10</li>
            <li>Accept → Total $29</li>
            <li>Decline → Total $19</li>
          </ul>
          <button onclick="testCheckout(29, 'with-bump')">Simulate Accept ($29)</button>
          <button onclick="testCheckout(19, 'no-bump')">Simulate Decline ($19)</button>
        </div>
      `;
      log('Order bump flow simulation ready');
    }

    // Initialize tests
    window.addEventListener('load', () => {
      log('Test page loaded');
      testPoolHealth();
    });
  </script>
</body>
</html>
